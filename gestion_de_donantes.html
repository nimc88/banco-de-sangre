<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bludee - Gesti√≥n de Donantes</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
      min-height: 100vh; padding: 20px;
    }
    .container {
      max-width: 1600px; margin: 0 auto;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border-radius: 20px; overflow: hidden;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }
    .header {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      color: white; padding: 30px; text-align: center;
    }
    .header h1 { font-size: 2.2rem; margin-bottom: 8px; }
    .breadcrumb { background: #f1f5f9; padding: 15px 30px; border-bottom: 1px solid #e2e8f0; }
    .form-container { padding: 40px; }
    .back-button {
      position: fixed; top: 20px; left: 20px;
      background: rgba(255, 255, 255, 0.9); border: 2px solid #e5e7eb;
      border-radius: 50px; padding: 12px 20px; color: #374151;
      text-decoration: none; font-weight: 600;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.3s ease; backdrop-filter: blur(10px); z-index: 1000;
    }
    .dashboard-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .dashboard-card {
      background: white; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
      transition: all 0.3s ease; text-align: center;
    }
    .dashboard-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
    .dashboard-label { font-size: 0.9rem; color: #6b7280; font-weight: 500; }
    .quick-actions {
      background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
    }
    .actions-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
    }
    .action-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 15px 20px; border: none; border-radius: 12px;
      text-align: center; transition: all 0.3s ease; cursor: pointer; font-weight: 600;
    }
    .action-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
    .tabs-container {
      background: white; border-radius: 12px; overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; margin-bottom: 25px;
    }
    .tabs-nav { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
    .tab-btn {
      flex: 1; padding: 15px 20px; background: none; border: none;
      cursor: pointer; font-weight: 600; color: #6b7280;
      transition: all 0.3s ease; border-bottom: 3px solid transparent;
    }
    .tab-btn.active { color: #dc2626; border-bottom-color: #dc2626; background: white; }
    .tab-content { padding: 30px; display: none; }
    .tab-content.active { display: block; }
    .donors-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;
    }
    .donor-card {
      background: white; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
      transition: all 0.3s ease; border-left: 4px solid var(--donor-status-color);
    }
    .donor-active { --donor-status-color: #10b981; }
    .donor-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .donor-name { font-size: 1.2rem; font-weight: bold; color: #1f2937; margin-bottom: 5px; }
    .donor-id { font-size: 0.85rem; color: #6b7280; font-family: monospace; }
    .donor-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-size: 0.8rem; color: #6b7280; margin-bottom: 2px; }
    .info-value { font-weight: 600; color: #1f2937; }
    .blood-type-badge {
      display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 12px;
      font-size: 0.8rem; font-weight: 600; background: #fef2f2; color: #991b1b; border: 1px solid #fecaca;
    }
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500;
      cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem;
    }
    .btn-primary { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
    .btn-secondary { background: #f8fafc; color: #374151; border: 1px solid #e5e7eb; }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: none;
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px;
      max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }
    .form-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px; margin-bottom: 20px;
    }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 0.95rem; }
    .required { color: #dc2626; }
    input, select, textarea {
      padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px;
      font-size: 1rem; transition: all 0.3s ease; background: #fafafa;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #3b82f6; background: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .success-message {
      display: none; background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin: 20px 0;
      text-align: center; color: #065f46; font-weight: 600; animation: slideDown 0.3s ease;
    }
    .success-message.show { display: block; }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .recordatorio-card {
      background: #fff7ed; border: 1px solid #fed7aa; border-left: 4px solid #f97316;
      border-radius: 8px; padding: 15px; margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-button">‚Üê Volver al Men√∫</a>

  <div class="container">
    <div class="header">
      <h1>üë• Gesti√≥n de Donantes</h1>
      <p>Sistema Bludee - Registro y Seguimiento de Donantes</p>
    </div>

    <div class="breadcrumb">
      <a href="index.html">üóÉÔ∏è Bludee</a> / 
      <a href="inventario_actual.html">Inventario y Recepci√≥n</a> / 
      <span>Gesti√≥n de Donantes</span>
    </div>

    <div class="form-container">
      <!-- Dashboard de Resumen -->
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <div class="dashboard-number" id="total-donors">0</div>
          <div class="dashboard-label">Total Donantes</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-number" id="active-donors">0</div>
          <div class="dashboard-label">Activos</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-number" id="eligible-donors">0</div>
          <div class="dashboard-label">Elegibles Hoy</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-number" id="new-donors">0</div>
          <div class="dashboard-label">Nuevos (30 d√≠as)</div>
        </div>
      </div>

      <!-- Acciones R√°pidas -->
      <div class="quick-actions">
        <h2 style="margin-bottom: 20px;">‚ö° Acciones R√°pidas</h2>
        <div class="actions-grid">
          <button class="action-btn" onclick="mostrarModalNuevoDonante()">
            ‚ûï Registrar Nuevo Donante
          </button>
          <button class="action-btn" onclick="mostrarModalNuevaCita()">
            üìÖ Programar Cita
          </button>
          <button class="action-btn" onclick="verDonantesElegibles()">
            ü©∏ Ver Donantes Elegibles
          </button>
          <button class="action-btn" onclick="verCitasHoy()">
            üïí Ver Citas de Hoy
          </button>
        </div>
      </div>

      <!-- Pesta√±as -->
      <div class="tabs-container">
        <div class="tabs-nav">
          <button class="tab-btn active" onclick="mostrarTab('donantes')">üë• Lista de Donantes</button>
          <button class="tab-btn" onclick="mostrarTab('elegibles')">ü©∏ Donantes Elegibles</button>
          <button class="tab-btn" onclick="mostrarTab('citas')">üìÖ Programar Citas</button>
          <button class="tab-btn" onclick="mostrarTab('recordatorios')">üìß Recordatorios</button>
          <button class="tab-btn" onclick="mostrarTab('estadisticas')">üìä Estad√≠sticas</button>
        </div>

        <!-- Pesta√±a: Lista de Donantes -->
        <div class="tab-content active" id="donantes-tab">
          <div style="margin-bottom: 20px;">
            <input type="text" id="buscar-donante" placeholder="Buscar donante por nombre, tel√©fono o tipo de sangre..." 
                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"
                   oninput="filtrarDonantes()">
          </div>
          <div class="donors-grid" id="lista-donantes">
            <!-- Los donantes se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>

        <!-- Pesta√±a: Donantes Elegibles -->
        <div class="tab-content" id="elegibles-tab">
          <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #0369a1; margin-bottom: 10px;">ü©∏ Donantes Elegibles para Donar</h3>
            <p style="color: #0369a1;">Donantes que han cumplido el per√≠odo de espera de 8 semanas desde su √∫ltima donaci√≥n.</p>
          </div>
          <div class="donors-grid" id="lista-elegibles">
            <!-- Los donantes elegibles se cargar√°n aqu√≠ -->
          </div>
        </div>

        <!-- Pesta√±a: Citas -->
        <div class="tab-content" id="citas-tab">
          <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="mostrarModalNuevaCita()" style="margin-right: 10px;">
              üìÖ Nueva Cita
            </button>
            <button class="btn btn-secondary" onclick="verCitasHoy()">
              üïí Citas de Hoy
            </button>
          </div>
          
          <!-- Lista de pr√≥ximas citas -->
          <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3>üïí Pr√≥ximas Citas</h3>
            <div id="lista-proximas-citas">
              <!-- Citas se cargar√°n aqu√≠ -->
            </div>
          </div>
        </div>

        <!-- Pesta√±a: Recordatorios -->
        <div class="tab-content" id="recordatorios-tab">
          <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="generarRecordatoriosAutomaticos()" style="margin-right: 10px;">
              üîÑ Generar Autom√°ticos
            </button>
            <button class="btn btn-primary" onclick="enviarTodosRecordatorios()">
              üìß Enviar Todos
            </button>
          </div>
          <div id="lista-recordatorios">
            <!-- Los recordatorios se cargar√°n aqu√≠ -->
          </div>
        </div>

        <!-- Pesta√±a: Estad√≠sticas -->
        <div class="tab-content" id="estadisticas-tab">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <h3>ü©∏ Por Tipo de Sangre</h3>
              <div id="stats-tipos-sangre"></div>
            </div>
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <h3>üìà Donaciones por Mes</h3>
              <div id="stats-donaciones-mes"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Nuevo Donante -->
  <div class="modal" id="modal-nuevo-donante">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px;">üë• Registrar Nuevo Donante</h3>
      
      <form id="form-nuevo-donante">
        <div class="form-grid">
          <div class="form-group">
            <label>üë§ Nombre Completo <span class="required">*</span></label>
            <input type="text" id="nombre" required>
          </div>
          <div class="form-group">
            <label>üë§ Apellido <span class="required">*</span></label>
            <input type="text" id="apellido" required>
          </div>
          <div class="form-group">
            <label>üìß Email</label>
            <input type="email" id="email">
          </div>
          <div class="form-group">
            <label>üìû Tel√©fono <span class="required">*</span></label>
            <input type="tel" id="telefono" required>
          </div>
          <div class="form-group">
            <label>ü©∏ Tipo de Sangre <span class="required">*</span></label>
            <select id="tipoSangre" required>
              <option value="">Seleccionar...</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
            </select>
          </div>
          <div class="form-group">
            <label>üìÖ Fecha de Nacimiento <span class="required">*</span></label>
            <input type="date" id="fechaNacimiento" required>
          </div>
          <div class="form-group full-width">
            <label>üìç Direcci√≥n</label>
            <textarea id="direccion" rows="3"></textarea>
          </div>
        </div>

        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
          <button type="button" class="btn btn-secondary" onclick="cerrarModal('modal-nuevo-donante')">
            ‚ùå Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            ‚úÖ Registrar Donante
          </button>
        </div>
      </form>

      <div class="success-message" id="mensaje-exito">
        ‚úÖ Donante registrado exitosamente
      </div>
    </div>
  </div>

  <!-- Modal para Nueva Cita -->
  <div class="modal" id="modal-nueva-cita">
    <div class="modal-content">
      <h3 style="margin-bottom: 20px;">üìÖ Programar Nueva Cita</h3>
      
      <form id="form-nueva-cita">
        <div class="form-grid">
          <div class="form-group">
            <label>üë§ Seleccionar Donante <span class="required">*</span></label>
            <select id="donante-cita" required>
              <option value="">Seleccionar donante...</option>
            </select>
          </div>
          <div class="form-group">
            <label>üìÖ Fecha <span class="required">*</span></label>
            <input type="date" id="fecha-cita" required>
          </div>
          <div class="form-group">
            <label>üïí Hora <span class="required">*</span></label>
            <select id="hora-cita" required>
              <option value="">Seleccionar hora...</option>
              <option value="08:00">08:00 AM</option>
              <option value="08:30">08:30 AM</option>
              <option value="09:00">09:00 AM</option>
              <option value="09:30">09:30 AM</option>
              <option value="10:00">10:00 AM</option>
              <option value="10:30">10:30 AM</option>
              <option value="11:00">11:00 AM</option>
              <option value="11:30">11:30 AM</option>
              <option value="14:00">02:00 PM</option>
              <option value="14:30">02:30 PM</option>
              <option value="15:00">03:00 PM</option>
              <option value="15:30">03:30 PM</option>
              <option value="16:00">04:00 PM</option>
              <option value="16:30">04:30 PM</option>
            </select>
          </div>
          <div class="form-group">
            <label>üè• Tipo de Cita</label>
            <select id="tipo-cita">
              <option value="donacion">Donaci√≥n Regular</option>
              <option value="seguimiento">Seguimiento</option>
              <option value="evaluacion">Evaluaci√≥n M√©dica</option>
              <option value="urgente">Donaci√≥n Urgente</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label>üìù Notas Adicionales</label>
            <textarea id="notas-cita" rows="3" placeholder="Instrucciones especiales, tipo de sangre necesario, etc."></textarea>
          </div>
        </div>

        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
          <button type="button" class="btn btn-secondary" onclick="cerrarModal('modal-nueva-cita')">
            ‚ùå Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            ‚úÖ Programar Cita
          </button>
        </div>
      </form>

      <div class="success-message" id="cita-success-message">
        ‚úÖ Cita programada exitosamente
      </div>
    </div>
  </div>

  <script>
    // Clase para gesti√≥n de citas
    class GestorCitas {
      constructor() {
        this.citas = JSON.parse(localStorage.getItem('citas')) || [];
      }

      programarCita(cita) {
        cita.id = Date.now() + Math.random();
        cita.estado = 'programada';
        cita.fechaCreacion = new Date().toISOString();
        
        this.citas.push(cita);
        this.guardarCitas();
        
        return cita.id;
      }

      obtenerCitasPorFecha(fecha) {
        return this.citas.filter(cita => 
          cita.fecha === fecha && cita.estado !== 'cancelada'
        );
      }

      obtenerCitasDelDia(fecha) {
        const fechaBusqueda = fecha || new Date().toISOString().split('T')[0];
        return this.obtenerCitasPorFecha(fechaBusqueda);
      }

      obtenerProximasCitas(dias) {
        const diasParam = dias || 7;
        const hoy = new Date();
        const fechaLimite = new Date();
        fechaLimite.setDate(hoy.getDate() + diasParam);

        return this.citas.filter(cita => {
          if (cita.estado === 'cancelada') return false;
          
          const fechaCita = new Date(cita.fecha);
          return fechaCita >= hoy && fechaCita <= fechaLimite;
        }).sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      }

      verificarDisponibilidad(fecha, hora) {
        const citasEnHorario = this.citas.filter(cita => 
          cita.fecha === fecha && 
          cita.hora === hora && 
          cita.estado === 'programada'
        );
        
        return citasEnHorario.length < 3; // M√°ximo 3 citas por horario
      }

      confirmarCita(citaId) {
        const cita = this.citas.find(c => c.id == citaId);
        if (cita) {
          cita.estado = 'confirmada';
          this.guardarCitas();
          return true;
        }
        return false;
      }

      cancelarCita(citaId, motivo) {
        const motivoCancelacion = motivo || '';
        const cita = this.citas.find(c => c.id == citaId);
        if (cita) {
          cita.estado = 'cancelada';
          cita.motivoCancelacion = motivoCancelacion;
          cita.fechaCancelacion = new Date().toISOString();
          this.guardarCitas();
          return true;
        }
        return false;
      }

      completarCita(citaId, notas) {
        const notasCita = notas || '';
        const cita = this.citas.find(c => c.id == citaId);
        if (cita) {
          cita.estado = 'completada';
          cita.notas = notasCita;
          cita.fechaComplecion = new Date().toISOString();
          this.guardarCitas();
          return true;
        }
        return false;
      }

      guardarCitas() {
        localStorage.setItem('citas', JSON.stringify(this.citas));
      }
    }

    // Clase para gesti√≥n de utilidades
    class Utilidades {
      static formatearFecha(fecha) {
        return new Date(fecha).toLocaleDateString('es-PR');
      }

      static calcularEdad(fechaNacimiento) {
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
          edad--;
        }
        return edad;
      }

      static validarEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      static validarTelefono(telefono) {
        return /^\(?(787|939)\)?[-.\s]?\d{3}[-.\s]?\d{4}$/.test(telefono);
      }

      static mostrarNotificacion(mensaje, tipo) {
        const tipoParam = tipo || 'info';
        const colores = {
          success: '#10b981',
          error: '#ef4444',
          warning: '#f59e0b',
          info: '#3b82f6'
        };

        const notificacion = document.createElement('div');
        notificacion.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 10000;
          background: ${colores[tipoParam]}; color: white; padding: 15px 20px;
          border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          font-weight: 600; min-width: 300px;
        `;
        notificacion.textContent = mensaje;
        
        document.body.appendChild(notificacion);
        setTimeout(() => notificacion.remove(), 3000);
      }
    }

    // Clase principal para gesti√≥n de donantes
    class GestorDonantes {
      constructor() {
        this.donantes = JSON.parse(localStorage.getItem('donantes')) || [];
        this.recordatorios = JSON.parse(localStorage.getItem('recordatorios')) || [];
        this.gestorCitas = new GestorCitas();
        this.inicializar();
      }

      inicializar() {
        this.actualizarDashboard();
        this.cargarListaDonantes();
        this.configurarEventos();
        
        // Crear datos de prueba si no hay donantes
        if (this.donantes.length === 0) {
          this.crearDatosPrueba();
        }
      }

      configurarEventos() {
        document.getElementById('form-nuevo-donante').addEventListener('submit', (e) => {
          e.preventDefault();
          this.registrarNuevoDonante();
        });

        document.getElementById('form-nueva-cita').addEventListener('submit', (e) => {
          e.preventDefault();
          this.programarNuevaCita();
        });

        // Establecer fecha m√≠nima para citas (hoy)
        const fechaInput = document.getElementById('fecha-cita');
        if (fechaInput) {
          const hoy = new Date().toISOString().split('T')[0];
          fechaInput.value = hoy;
          fechaInput.min = hoy;
        }
      }

      crearDatosPrueba() {
        const donantesEjemplo = [
          {
            nombre: 'Mar√≠a Elena',
            apellido: 'Rodr√≠guez',
            email: 'maria.rodriguez@email.com',
            telefono: '(787) 555-0123',
            tipoSangre: 'O+',
            fechaNacimiento: '1989-03-15',
            direccion: 'San Juan, PR',
            ultimaDonacion: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
          },
          {
            nombre: 'Carlos Alberto',
            apellido: 'Jim√©nez',
            email: 'carlos.jimenez@email.com',
            telefono: '(787) 555-0456',
            tipoSangre: 'A-',
            fechaNacimiento: '1981-07-22',
            direccion: 'Bayam√≥n, PR',
            ultimaDonacion: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
          },
          {
            nombre: 'Ana Isabel',
            apellido: 'Torres',
            email: 'ana.torres@email.com',
            telefono: '(939) 555-0789',
            tipoSangre: 'B+',
            fechaNacimiento: '1997-11-08',
            direccion: 'Carolina, PR',
            ultimaDonacion: new Date(Date.now() - 65 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
          }
        ];

        donantesEjemplo.forEach(donante => {
          this.agregarDonante(donante);
        });
      }

      agregarDonante(donante) {
        donante.id = Date.now() + Math.random();
        donante.activo = true;
        donante.fechaRegistro = new Date().toISOString();
        
        this.donantes.push(donante);
        this.guardarDatos();
        return donante.id;
      }

      obtenerDonantesElegibles() {
        const fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - 56); // 8 semanas

        return this.donantes.filter(donante => {
          if (!donante.activo) return false;
          if (!donante.ultimaDonacion) return true;
          
          const ultimaDonacion = new Date(donante.ultimaDonacion);
          return ultimaDonacion <= fechaLimite;
        });
      }

      registrarNuevoDonante() {
        const nombre = document.getElementById('nombre').value.trim();
        const apellido = document.getElementById('apellido').value.trim();
        const email = document.getElementById('email').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const tipoSangre = document.getElementById('tipoSangre').value;
        const fechaNacimiento = document.getElementById('fechaNacimiento').value;
        const direccion = document.getElementById('direccion').value.trim();

        // Validaciones
        if (!nombre || !apellido || !telefono || !tipoSangre || !fechaNacimiento) {
          Utilidades.mostrarNotificacion('Por favor completa todos los campos obligatorios', 'error');
          return;
        }

        if (email && !Utilidades.validarEmail(email)) {
          Utilidades.mostrarNotificacion('Por favor ingresa un email v√°lido', 'error');
          return;
        }

        if (!Utilidades.validarTelefono(telefono)) {
          Utilidades.mostrarNotificacion('Por favor ingresa un tel√©fono v√°lido de PR', 'error');
          return;
        }

        const edad = Utilidades.calcularEdad(fechaNacimiento);
        if (edad < 18 || edad > 65) {
          Utilidades.mostrarNotificacion('El donante debe tener entre 18 y 65 a√±os', 'error');
          return;
        }

        const nuevoDonante = {
          nombre, apellido, email, telefono, tipoSangre,
          fechaNacimiento, direccion
        };

        this.agregarDonante(nuevoDonante);
        
        // Mostrar mensaje de √©xito
        document.getElementById('mensaje-exito').classList.add('show');
        
        setTimeout(() => {
          this.cerrarModal('modal-nuevo-donante');
          this.actualizarDashboard();
          this.cargarListaDonantes();
          Utilidades.mostrarNotificacion(`Donante ${nombre} ${apellido} registrado exitosamente`, 'success');
        }, 1500);
      }

      programarNuevaCita() {
        const donanteId = document.getElementById('donante-cita').value;
        const fecha = document.getElementById('fecha-cita').value;
        const hora = document.getElementById('hora-cita').value;
        const tipo = document.getElementById('tipo-cita').value;
        const notas = document.getElementById('notas-cita').value;

        if (!donanteId || !fecha || !hora) {
          Utilidades.mostrarNotificacion('Por favor completa todos los campos obligatorios', 'error');
          return;
        }

        // Verificar disponibilidad
        if (!this.gestorCitas.verificarDisponibilidad(fecha, hora)) {
          Utilidades.mostrarNotificacion('No hay disponibilidad en esa fecha y hora', 'error');
          return;
        }

        const donante = this.donantes.find(d => d.id == donanteId);
        if (!donante) {
          Utilidades.mostrarNotificacion('Donante no encontrado', 'error');
          return;
        }

        // Verificar si el donante es elegible (solo para citas de donaci√≥n)
        if (tipo === 'donacion' && !this.esElegible(donante)) {
          const proximaFecha = this.calcularProximaFechaElegible(donante);
          Utilidades.mostrarNotificacion(`El donante no es elegible hasta ${proximaFecha}`, 'warning');
          return;
        }

        const nuevaCita = {
          donanteId: donanteId,
          donante: donante,
          fecha: fecha,
          hora: hora,
          tipo: tipo,
          notas: notas
        };

        this.gestorCitas.programarCita(nuevaCita);
        
        // Mostrar mensaje de √©xito
        document.getElementById('cita-success-message').classList.add('show');
        
        setTimeout(() => {
          this.cerrarModal('modal-nueva-cita');
          Utilidades.mostrarNotificacion(`Cita programada para ${donante.nombre} ${donante.apellido}`, 'success');
        }, 1500);
      }

      calcularProximaFechaElegible(donante) {
        if (!donante.ultimaDonacion) return 'Ya es elegible';
        
        const ultimaDonacion = new Date(donante.ultimaDonacion);
        const proximaFecha = new Date(ultimaDonacion);
        proximaFecha.setDate(proximaFecha.getDate() + 56); // 8 semanas
        
        return Utilidades.formatearFecha(proximaFecha.toISOString());
      }

      cargarDonantesEnSelector() {
        const select = document.getElementById('donante-cita');
        if (!select) return;

        select.innerHTML = '<option value="">Seleccionar donante...</option>';
        
        this.donantes.forEach(donante => {
          if (donante.activo) {
            const option = document.createElement('option');
            option.value = donante.id;
            option.textContent = `${donante.nombre} ${donante.apellido} (${donante.tipoSangre})`;
            select.appendChild(option);
          }
        });
      }

      cargarListaDonantes() {
        const container = document.getElementById('lista-donantes');
        container.innerHTML = '';

        this.donantes.forEach(donante => {
          if (!donante.activo) return;

          const edad = Utilidades.calcularEdad(donante.fechaNacimiento);
          const diasSinDonar = donante.ultimaDonacion ? 
            Math.floor((new Date() - new Date(donante.ultimaDonacion)) / (1000 * 60 * 60 * 24)) : 
            'Nunca ha donado';

          const card = document.createElement('div');
          card.className = 'donor-card donor-active';
          card.innerHTML = `
            <div class="donor-header">
              <div>
                <div class="donor-name">${donante.nombre} ${donante.apellido}</div>
                <div class="donor-id">ID: ${donante.id.toString().slice(-6)}</div>
              </div>
              <div style="padding: 4px 8px; background: #d1fae5; color: #065f46; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                Activo
              </div>
            </div>

            <div class="donor-info">
              <div class="info-item">
                <div class="info-label">Tipo de Sangre</div>
                <div class="info-value">
                  <span class="blood-type-badge">${donante.tipoSangre}</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-label">Edad</div>
                <div class="info-value">${edad} a√±os</div>
              </div>
              <div class="info-item">
                <div class="info-label">Tel√©fono</div>
                <div class="info-value">${donante.telefono}</div>
              </div>
              <div class="info-item">
                <div class="info-label">√öltima Donaci√≥n</div>
                <div class="info-value">${donante.ultimaDonacion ? Utilidades.formatearFecha(donante.ultimaDonacion) : 'Nunca'}</div>
              </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
              <button class="btn btn-secondary" onclick="gestor.verDetallesDonante('${donante.id}')">
                üëÅÔ∏è Ver
              </button>
              <button class="btn btn-secondary" onclick="gestor.contactarDonante('${donante.id}')">
                üìû Contactar
              </button>
              ${this.esElegible(donante) ? 
                `<button class="btn btn-primary" onclick="gestor.programarCitaDonante('${donante.id}')">üìÖ Cita</button>` :
                `<span style="font-size: 0.8rem; color: #6b7280;">No elegible a√∫n</span>`
              }
            </div>
          `;
          
          container.appendChild(card);
        });
      }

      cargarDonantesElegibles() {
        const container = document.getElementById('lista-elegibles');
        const elegibles = this.obtenerDonantesElegibles();
        container.innerHTML = '';

        if (elegibles.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <p>No hay donantes elegibles en este momento</p>
            </div>
          `;
          return;
        }

        elegibles.forEach(donante => {
          const edad = Utilidades.calcularEdad(donante.fechaNacimiento);
          const diasSinDonar = donante.ultimaDonacion ? 
            Math.floor((new Date() - new Date(donante.ultimaDonacion)) / (1000 * 60 * 60 * 24)) : 
            '‚àû';

          const card = document.createElement('div');
          card.className = 'donor-card';
          card.style.borderLeft = '4px solid #10b981';
          card.innerHTML = `
            <div class="donor-header">
              <div>
                <div class="donor-name">${donante.nombre} ${donante.apellido}</div>
                <div class="donor-id">Tipo: ${donante.tipoSangre} ‚Ä¢ ${edad} a√±os</div>
              </div>
              <div style="padding: 4px 8px; background: #d1fae5; color: #065f46; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                ‚úÖ Elegible
              </div>
            </div>

            <div style="margin: 15px 0;">
              <p><strong>Tel√©fono:</strong> ${donante.telefono}</p>
              <p><strong>√öltima donaci√≥n:</strong> ${donante.ultimaDonacion ? Utilidades.formatearFecha(donante.ultimaDonacion) : 'Nunca'}</p>
              <p><strong>D√≠as sin donar:</strong> ${diasSinDonar}</p>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="gestor.programarCitaDonante('${donante.id}')">
                üìÖ Programar Cita
              </button>
              <button class="btn btn-secondary" onclick="gestor.programarRecordatorio('${donante.id}')">
                üìß Recordatorio
              </button>
              <button class="btn btn-secondary" onclick="gestor.contactarDonante('${donante.id}')">
                üìû Llamar
              </button>
            </div>
          `;
          
          container.appendChild(card);
        });
      }

      cargarCitas() {
        const container = document.getElementById('lista-proximas-citas');
        if (!container) return;

        const proximasCitas = this.gestorCitas.obtenerProximasCitas(7);
        container.innerHTML = '';

        if (proximasCitas.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <p>No hay citas programadas para los pr√≥ximos 7 d√≠as</p>
            </div>
          `;
          return;
        }

        proximasCitas.forEach(cita => {
          const card = document.createElement('div');
          card.className = 'recordatorio-card';
          card.style.borderLeft = '4px solid #3b82f6';
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4>${cita.donante.nombre} ${cita.donante.apellido}</h4>
                <p style="margin: 5px 0; color: #6b7280;">
                  üìÖ ${Utilidades.formatearFecha(cita.fecha)} a las ${cita.hora} 
                  ‚Ä¢ Tipo: ${cita.donante.tipoSangre}
                </p>
                <p style="margin: 5px 0; font-size: 0.9rem;">
                  <strong>Tipo de cita:</strong> ${this.getTipoCitaLabel(cita.tipo)}
                </p>
                ${cita.notas ? `<p style="margin: 5px 0; font-size: 0.9rem; color: #6b7280;"><strong>Notas:</strong> ${cita.notas}</p>` : ''}
              </div>
              <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="btn btn-primary" onclick="gestor.confirmarCita('${cita.id}')">
                  ‚úÖ Confirmar
                </button>
                <button class="btn btn-secondary" onclick="gestor.contactarDonante('${cita.donanteId}')">
                  üìû Llamar
                </button>
                <button class="btn btn-secondary" onclick="gestor.cancelarCita('${cita.id}')">
                  ‚ùå Cancelar
                </button>
              </div>
            </div>
          `;
          
          container.appendChild(card);
        });
      }

      cargarRecordatorios() {
        const container = document.getElementById('lista-recordatorios');
        container.innerHTML = '';

        const pendientes = this.recordatorios.filter(r => !r.enviado);

        if (pendientes.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280;">
              <p>No hay recordatorios pendientes</p>
            </div>
          `;
          return;
        }

        pendientes.forEach(recordatorio => {
          const card = document.createElement('div');
          card.className = 'recordatorio-card';
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4>${recordatorio.donante.nombre} ${recordatorio.donante.apellido}</h4>
                <p style="margin: 5px 0; color: #6b7280;">Tipo: ${recordatorio.donante.tipoSangre} ‚Ä¢ ${recordatorio.donante.telefono}</p>
                <p style="margin: 5px 0; font-size: 0.9rem;">${recordatorio.mensaje}</p>
              </div>
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="gestor.enviarRecordatorio('${recordatorio.id}')">
                  üìß Enviar
                </button>
                <button class="btn btn-secondary" onclick="gestor.eliminarRecordatorio('${recordatorio.id}')">
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </div>
          `;
          
          container.appendChild(card);
        });
      }

      esElegible(donante) {
        if (!donante.ultimaDonacion) return true;
        
        const fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - 56);
        
        return new Date(donante.ultimaDonacion) <= fechaLimite;
      }

      programarCitaDonante(donanteId) {
        // Pre-seleccionar el donante y abrir modal de cita
        this.cargarDonantesEnSelector();
        setTimeout(() => {
          document.getElementById('donante-cita').value = donanteId;
        }, 100);
        document.getElementById('modal-nueva-cita').classList.add('show');
      }

      programarRecordatorio(donanteId) {
        const donante = this.donantes.find(d => d.id == donanteId);
        if (!donante) return;

        const recordatorio = {
          id: Date.now(),
          donanteId: donanteId,
          donante: donante,
          tipo: 'donacion',
          mensaje: `¬°Hola ${donante.nombre}! Ya puedes donar sangre nuevamente. Tu donaci√≥n puede salvar vidas.`,
          fechaCreacion: new Date().toISOString(),
          enviado: false
        };

        this.recordatorios.push(recordatorio);
        this.guardarDatos();
        
        Utilidades.mostrarNotificacion(`Recordatorio programado para ${donante.nombre}`, 'success');
        this.cargarRecordatorios();
      }

      enviarRecordatorio(recordatorioId) {
        const recordatorio = this.recordatorios.find(r => r.id == recordatorioId);
        if (!recordatorio) return;

        recordatorio.enviado = true;
        recordatorio.fechaEnvio = new Date().toISOString();
        
        this.guardarDatos();
        this.cargarRecordatorios();
        
        Utilidades.mostrarNotificacion(`Recordatorio enviado a ${recordatorio.donante.nombre}`, 'success');
      }

      eliminarRecordatorio(recordatorioId) {
        this.recordatorios = this.recordatorios.filter(r => r.id != recordatorioId);
        this.guardarDatos();
        this.cargarRecordatorios();
        
        Utilidades.mostrarNotificacion('Recordatorio eliminado', 'info');
      }

      generarRecordatoriosAutomaticos() {
        const elegibles = this.obtenerDonantesElegibles();
        let nuevos = 0;

        elegibles.forEach(donante => {
          // Verificar si ya tiene recordatorio pendiente
          const yaEsPendiente = this.recordatorios.some(r => 
            r.donanteId == donante.id && !r.enviado
          );

          if (!yaEsPendiente) {
            this.programarRecordatorio(donante.id);
            nuevos++;
          }
        });

        Utilidades.mostrarNotificacion(`Se crearon ${nuevos} nuevos recordatorios autom√°ticos`, 'success');
      }

      enviarTodosRecordatorios() {
        const pendientes = this.recordatorios.filter(r => !r.enviado);
        
        pendientes.forEach(recordatorio => {
          recordatorio.enviado = true;
          recordatorio.fechaEnvio = new Date().toISOString();
        });

        this.guardarDatos();
        this.cargarRecordatorios();
        
        Utilidades.mostrarNotificacion(`${pendientes.length} recordatorios enviados`, 'success');
      }

      getTipoCitaLabel(tipo) {
        const labels = {
          'donacion': 'Donaci√≥n Regular',
          'seguimiento': 'Seguimiento',
          'evaluacion': 'Evaluaci√≥n M√©dica',
          'urgente': 'Donaci√≥n Urgente'
        };
        return labels[tipo] || tipo;
      }

      confirmarCita(citaId) {
        if (this.gestorCitas.confirmarCita(citaId)) {
          Utilidades.mostrarNotificacion('Cita confirmada exitosamente', 'success');
          this.cargarCitas();
        }
      }

      cancelarCita(citaId) {
        const motivo = prompt('¬øMotivo de la cancelaci√≥n? (opcional)');
        if (motivo !== null) { // Usuario no cancel√≥ el prompt
          if (this.gestorCitas.cancelarCita(citaId, motivo)) {
            Utilidades.mostrarNotificacion('Cita cancelada', 'info');
            this.cargarCitas();
          }
        }
      }

      verCitasHoy() {
        const hoy = new Date().toISOString().split('T')[0];
        const citasHoy = this.gestorCitas.obtenerCitasDelDia(hoy);
        
        if (citasHoy.length === 0) {
          alert('No hay citas programadas para hoy');
          return;
        }

        let mensaje = `üìÖ CITAS DE HOY (${Utilidades.formatearFecha(hoy)})\n\n`;
        
        citasHoy.forEach((cita, index) => {
          mensaje += `${index + 1}. ${cita.hora} - ${cita.donante.nombre} ${cita.donante.apellido}\n`;
          mensaje += `   Tipo: ${cita.donante.tipoSangre} ‚Ä¢ ${this.getTipoCitaLabel(cita.tipo)}\n`;
          mensaje += `   Estado: ${cita.estado}\n\n`;
        });

        alert(mensaje);
      }

      actualizarDashboard() {
        const activos = this.donantes.filter(d => d.activo);
        const elegibles = this.obtenerDonantesElegibles();
        const nuevos = this.donantes.filter(d => {
          const registro = new Date(d.fechaRegistro);
          const hace30dias = new Date();
          hace30dias.setDate(hace30dias.getDate() - 30);
          return registro > hace30dias;
        });

        document.getElementById('total-donors').textContent = activos.length;
        document.getElementById('active-donors').textContent = activos.length;
        document.getElementById('eligible-donors').textContent = elegibles.length;
        document.getElementById('new-donors').textContent = nuevos.length;
      }

      verDetallesDonante(donanteId) {
        const donante = this.donantes.find(d => d.id == donanteId);
        if (!donante) return;

        const edad = Utilidades.calcularEdad(donante.fechaNacimiento);
        const detalles = `Detalles del Donante\n\nNombre: ${donante.nombre} ${donante.apellido}\nEdad: ${edad} a√±os\nTipo de Sangre: ${donante.tipoSangre}\nTel√©fono: ${donante.telefono}\nEmail: ${donante.email || 'No proporcionado'}\nDirecci√≥n: ${donante.direccion || 'No proporcionado'}\nFecha de Registro: ${Utilidades.formatearFecha(donante.fechaRegistro)}\n√öltima Donaci√≥n: ${donante.ultimaDonacion ? Utilidades.formatearFecha(donante.ultimaDonacion) : 'Nunca'}\nEstado: ${this.esElegible(donante) ? 'Elegible para donar' : 'No elegible a√∫n'}`;

        alert(detalles);
      }

      contactarDonante(donanteId) {
        const donante = this.donantes.find(d => d.id == donanteId);
        if (!donante) return;

        alert(`Contactar a ${donante.nombre} ${donante.apellido}\n\nTel√©fono: ${donante.telefono}\nEmail: ${donante.email || 'No disponible'}\n\n(Esta funci√≥n abrir√° tu aplicaci√≥n de tel√©fono o email)`);
      }

      cerrarModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
        if (modalId === 'modal-nuevo-donante') {
          document.getElementById('form-nuevo-donante').reset();
          document.getElementById('mensaje-exito').classList.remove('show');
        } else if (modalId === 'modal-nueva-cita') {
          document.getElementById('form-nueva-cita').reset();
          document.getElementById('cita-success-message').classList.remove('show');
          // Restablecer fecha m√≠nima
          const fechaInput = document.getElementById('fecha-cita');
          if (fechaInput) {
            fechaInput.value = new Date().toISOString().split('T')[0];
          }
        }
      }

      guardarDatos() {
        localStorage.setItem('donantes', JSON.stringify(this.donantes));
        localStorage.setItem('recordatorios', JSON.stringify(this.recordatorios));
      }
    }

    // Variables globales
    let gestor;
    let tabActual = 'donantes';

    // Funciones globales para los botones
    function mostrarModalNuevoDonante() {
      document.getElementById('modal-nuevo-donante').classList.add('show');
    }

    function mostrarModalNuevaCita() {
      gestor.cargarDonantesEnSelector();
      document.getElementById('modal-nueva-cita').classList.add('show');
    }

    function verDonantesElegibles() {
      mostrarTab('elegibles');
    }

    function verCitasHoy() {
      gestor.verCitasHoy();
    }

    function enviarRecordatorios() {
      mostrarTab('recordatorios');
    }

    function generarReporte() {
      const stats = {
        total: gestor.donantes.filter(d => d.activo).length,
        elegibles: gestor.obtenerDonantesElegibles().length,
        recordatoriosPendientes: gestor.recordatorios.filter(r => !r.enviado).length
      };

      alert(`üìä REPORTE DEL SISTEMA\n\nTotal de donantes: ${stats.total}\nDonantes elegibles: ${stats.elegibles}\nRecordatorios pendientes: ${stats.recordatoriosPendientes}\n\nPr√≥ximamente: Exportar a PDF`);
    }

    function mostrarTab(nombreTab) {
      tabActual = nombreTab;
      
      // Actualizar botones
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Mostrar contenido
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(nombreTab + '-tab').classList.add('active');
      
      // Cargar datos seg√∫n la pesta√±a
      switch(nombreTab) {
        case 'donantes':
          gestor.cargarListaDonantes();
          break;
        case 'elegibles':
          gestor.cargarDonantesElegibles();
          break;
        case 'citas':
          gestor.cargarCitas();
          break;
        case 'recordatorios':
          gestor.cargarRecordatorios();
          break;
        case 'estadisticas':
          // Cargar estad√≠sticas
          break;
      }
    }

    function cerrarModal(modalId) {
      gestor.cerrarModal(modalId);
    }

    function generarRecordatoriosAutomaticos() {
      gestor.generarRecordatoriosAutomaticos();
    }

    function enviarTodosRecordatorios() {
      gestor.enviarTodosRecordatorios();
    }

    function filtrarDonantes() {
      const termino = document.getElementById('buscar-donante').value.toLowerCase();
      const cards = document.querySelectorAll('#lista-donantes .donor-card');
      
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        card.style.display = texto.includes(termino) ? 'block' : 'none';
      });
    }

    // Inicializar cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', function() {
      gestor = new GestorDonantes();
    });

    // Cerrar modales al hacer clic fuera
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });
  </script>
</body>
</html>
