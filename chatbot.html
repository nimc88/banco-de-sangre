<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLUDEE Assistant - Chatbot Cl√≠nico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
        }

        .sidebar {
            width: 350px;
            background: linear-gradient(180deg, #2c3e50, #34495e);
            color: white;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="medical" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 10 0 L 10 20 M 0 10 L 20 10" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23medical)"/></svg>');
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .sidebar-header h2 {
            color: #e74c3c;
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar-header p {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .tools-section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 2;
        }

        .tools-section h3 {
            color: #ecf0f1;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-category {
            margin-bottom: 25px;
        }

        .tool-btn {
            width: 100%;
            background: rgba(52, 73, 94, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ecf0f1;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-btn:hover {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            transform: translateX(5px);
        }

        .tool-btn.active {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .safety-panel {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            position: relative;
            z-index: 2;
        }

        .safety-panel h4 {
            color: #e74c3c;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .safety-panel ul {
            list-style: none;
            font-size: 0.8rem;
            color: #ecf0f1;
        }

        .safety-panel li {
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }

        .safety-panel li::before {
            content: '‚ö†Ô∏è';
            position: absolute;
            left: 0;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .chat-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
        }

        .chat-header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: messageAppear 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-avatar.bot {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-content {
            background: white;
            color: #2c3e50;
            border: 1px solid #e1e8ed;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 5px;
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .clinical-info {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #d35400;
        }

        .clinical-info h5 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .safety-warning {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #a93226;
        }

        .safety-warning h5 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .protocol-steps {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .protocol-steps h5 {
            color: #27ae60;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .protocol-steps ol {
            color: #2c3e50;
            padding-left: 20px;
        }

        .protocol-steps li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .calculation-result {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .calculation-result h5 {
            margin-bottom: 10px;
        }

        .calculation-result .result {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e8ed;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 12px 50px 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            resize: none;
            min-height: 45px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .attach-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #95a5a6;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .attach-btn:hover {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .typing-indicator .message-avatar {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .typing-dots {
            background: white;
            padding: 15px 20px;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .quick-action {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            background: #e74c3c;
            color: white;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e5e7eb;
            border-radius: 50px;
            padding: 12px 20px;
            color: #374151;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .back-btn:hover {
            background: white;
            border-color: #3b82f6;
            color: #1e40af;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 300px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .chat-header h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚Üê Volver al Sistema</a>

    <div class="chat-container">
        <!-- Sidebar con herramientas -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ü§ñ BLUDEE Assistant</h2>
                <p>Experto Cl√≠nico en Banco de Sangre</p>
            </div>

            <div class="tools-section">
                <!-- Herramientas Cl√≠nicas -->
                <div class="tool-category">
                    <h3>üî¨ Herramientas Cl√≠nicas</h3>
                    <button class="tool-btn" onclick="useTool('compatibility')">
                        üß™ Pruebas de Compatibilidad
                    </button>
                    <button class="tool-btn" onclick="useTool('crossmatch')">
                        ‚öóÔ∏è Protocolo Crossmatch
                    </button>
                    <button class="tool-btn" onclick="useTool('antibodies')">
                        üîç Identificaci√≥n de Anticuerpos
                    </button>
                    <button class="tool-btn" onclick="useTool('transfusion')">
                        üíâ C√°lculo de Transfusi√≥n
                    </button>
                </div>

                <!-- Calculadoras -->
                <div class="tool-category">
                    <h3>üìä Calculadoras</h3>
                    <button class="tool-btn" onclick="useTool('volume')">
                        üìè Volumen de Sangre
                    </button>
                    <button class="tool-btn" onclick="useTool('dilution')">
                        ‚öñÔ∏è C√°lculo de Diluciones
                    </button>
                    <button class="tool-btn" onclick="useTool('expiration')">
                        üìÖ Fecha de Vencimiento
                    </button>
                    <button class="tool-btn" onclick="useTool('inventory')">
                        üì¶ Rotaci√≥n de Inventario
                    </button>
                </div>

                <!-- Protocolos -->
                <div class="tool-category">
                    <h3>üìã Protocolos</h3>
                    <button class="tool-btn" onclick="useTool('emergency')">
                        üö® Protocolo de Emergencia
                    </button>
                    <button class="tool-btn" onclick="useTool('quality')">
                        üéØ Control de Calidad
                    </button>
                    <button class="tool-btn" onclick="useTool('storage')">
                        üå°Ô∏è Condiciones de Almacenamiento
                    </button>
                    <button class="tool-btn" onclick="useTool('safety')">
                        üõ°Ô∏è Seguridad del Paciente
                    </button>
                </div>

                <!-- Referencias -->
                <div class="tool-category">
                    <h3>üìö Referencias</h3>
                    <button class="tool-btn" onclick="useTool('guidelines')">
                        üìñ Gu√≠as Cl√≠nicas
                    </button>
                    <button class="tool-btn" onclick="useTool('regulations')">
                        ‚öñÔ∏è Regulaciones FDA/AABB
                    </button>
                    <button class="tool-btn" onclick="useTool('complications')">
                        ‚ö†Ô∏è Complicaciones Transfusionales
                    </button>
                </div>
            </div>

            <!-- Panel de Seguridad -->
            <div class="safety-panel">
                <h4>üõ°Ô∏è Pol√≠ticas de Seguridad</h4>
                <ul>
                    <li>Verificaci√≥n doble identidad</li>
                    <li>Confirmaci√≥n tipo sangu√≠neo</li>
                    <li>Protocolo de emergencia activo</li>
                    <li>Trazabilidad completa</li>
                    <li>Documentaci√≥n obligatoria</li>
                </ul>
            </div>
        </div>

        <!-- Chat principal -->
        <div class="main-chat">
            <div class="chat-header">
                <h1>ü©∏ Asistente Cl√≠nico BLUDEE</h1>
                <div class="chat-controls">
                    <button class="control-btn" onclick="clearChat()">üóëÔ∏è Limpiar</button>
                    <button class="control-btn" onclick="exportChat()">üíæ Exportar</button>
                    <button class="control-btn" onclick="toggleVoice()">üé§ Voz</button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <!-- Mensaje de bienvenida -->
                <div class="message bot">
                    <div class="message-avatar bot">ü§ñ</div>
                    <div class="message-content">
                        <strong>¬°Hola! Soy tu Asistente Cl√≠nico BLUDEE</strong><br><br>
                        
                        Soy un especialista en banco de sangre con acceso a:
                        
                        <div class="clinical-info">
                            <h5>üî¨ Capacidades Cl√≠nicas</h5>
                            ‚Ä¢ Interpretaci√≥n de pruebas de compatibilidad<br>
                            ‚Ä¢ Protocolos de transfusi√≥n segura<br>
                            ‚Ä¢ Identificaci√≥n de anticuerpos<br>
                            ‚Ä¢ C√°lculos de dosificaci√≥n
                        </div>
                        
                        <div class="protocol-steps">
                            <h5>üìã Protocolos Disponibles</h5>
                            <ol>
                                <li>Emergencias y despacho urgente</li>
                                <li>Control de calidad de unidades</li>
                                <li>Manejo de reacciones transfusionales</li>
                                <li>Trazabilidad y documentaci√≥n</li>
                            </ol>
                        </div>
                        
                        <div class="safety-warning">
                            <h5>‚ö†Ô∏è Importante</h5>
                            Toda informaci√≥n debe ser validada por el personal cl√≠nico autorizado. En emergencias, sigue siempre los protocolos establecidos.
                        </div>
                        
                        <div class="quick-actions">
                            <span class="quick-action" onclick="sendQuickMessage('¬øC√≥mo interpreto una prueba cruzada?')">Prueba cruzada</span>
                            <span class="quick-action" onclick="sendQuickMessage('Protocolo de emergencia tipo O negativo')">Emergencia O-</span>
                            <span class="quick-action" onclick="sendQuickMessage('¬øC√≥mo identificar anticuerpos irregulares?')">Anticuerpos</span>
                            <span class="quick-action" onclick="sendQuickMessage('Calcular volumen de transfusi√≥n pedi√°trica')">C√°lculo pedi√°trico</span>
                        </div>
                        
                        <div class="message-time">Sistema iniciado - Listo para consultas cl√≠nicas</div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-group">
                    <textarea 
                        id="messageInput" 
                        class="chat-input" 
                        placeholder="Escribe tu consulta cl√≠nica aqu√≠... (ej: ¬øC√≥mo interpretar una prueba de Coombs positiva?)"
                        rows="1"
                    ></textarea>
                    <button class="attach-btn" onclick="attachFile()">üìé</button>
                </div>
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script>
        // Base de conocimiento RAG del banco de sangre
        const knowledgeBase = {
            compatibility: {
                crossmatch: {
                    definition: "Prueba para detectar incompatibilidad entre sangre del donante y receptor",
                    procedure: [
                        "Mezclar suero del receptor con gl√≥bulos rojos del donante",
                        "Incubar a 37¬∞C por 15-30 minutos",
                        "Centrifugar y examinar para hem√≥lisis y aglutinaci√≥n",
                        "Realizar prueba de antiglobulina si es necesario"
                    ],
                    interpretation: {
                        compatible: "Sin aglutinaci√≥n ni hem√≥lisis - COMPATIBLE",
                        incompatible: "Presencia de aglutinaci√≥n o hem√≥lisis - INCOMPATIBLE"
                    },
                    safety: "NUNCA transfundir sangre con prueba cruzada incompatible"
                },
                abo_rh: {
                    groups: {
                        "A+": "Puede recibir: A+, A-, O+, O-",
                        "A-": "Puede recibir: A-, O-",
                        "B+": "Puede recibir: B+, B-, O+, O-",
                        "B-": "Puede recibir: B-, O-",
                        "AB+": "Receptor universal - Puede recibir: todos los tipos",
                        "AB-": "Puede recibir: AB-, A-, B-, O-",
                        "O+": "Puede recibir: O+, O-",
                        "O-": "Donante universal - Solo puede recibir: O-"
                    }
                }
            },
            antibodies: {
                common: {
                    "Anti-D": {
                        significance: "Cl√≠nicamente significativo",
                        transfusion: "Usar sangre Rh negativa",
                        pregnancy: "Alto riesgo de enfermedad hemol√≠tica"
                    },
                    "Anti-K": {
                        significance: "Cl√≠nicamente significativo",
                        frequency: "Presente en 9% de la poblaci√≥n",
                        transfusion: "Usar sangre K negativa"
                    },
                    "Anti-E": {
                        significance: "Cl√≠nicamente significativo",
                        transfusion: "Usar sangre E negativa",
                        notes: "Com√∫n en pacientes multitransfundidos"
                    }
                },
                identification: [
                    "Realizar panel de c√©lulas para identificar especificidad",
                    "Verificar patr√≥n de reactividad",
                    "Confirmar con c√©lulas adicionales si es necesario",
                    "Documentar t√≠tulo si es cl√≠nicamente relevante"
                ]
            },
            transfusion: {
                volumes: {
                    adult: "1 unidad de GR aumenta Hb ~1 g/dL y Hct ~3%",
                    pediatric: "10-15 mL/kg de peso corporal",
                    platelet: "1 unidad por cada 10 kg de peso",
                    plasma: "10-15 mL/kg para correcci√≥n de coagulopat√≠a"
                },
                rates: {
                    standard: "1-2 mL/min para primeros 15 minutos, luego hasta 5 mL/min",
                    emergency: "M√°ximo tolerable seg√∫n condici√≥n del paciente",
                    pediatric: "No exceder 5 mL/kg/hora salvo emergencia"
                }
            },
            storage: {
                red_cells: {
                    temperature: "1-6¬∞C",
                    duration: "35-42 d√≠as seg√∫n soluci√≥n conservante",
                    monitoring: "Temperatura cada 4 horas"
                },
                platelets: {
                    temperature: "20-24¬∞C con agitaci√≥n continua",
                    duration: "5 d√≠as m√°ximo",
                    monitoring: "Agitaci√≥n y temperatura continua"
                },
                plasma: {
                    frozen: "-18¬∞C o menor por hasta 12 meses",
                    thawed: "1-6¬∞C por m√°ximo 24 horas"
                }
            },
            emergencies: {
                massive_transfusion: [
                    "Activar protocolo de transfusi√≥n masiva",
                    "Usar sangre O negativo si tipo desconocido",
                    "Ratio 1:1:1 (GR:Plasma:Plaquetas)",
                    "Monitorear laboratorios cada 4 unidades",
                    "Considerar √°cido tranex√°mico"
                ],
                reactions: {
                    hemolytic: {
                        signs: "Fiebre, dolor lumbar, hemoglobinuria, hipotensi√≥n",
                        action: "PARAR INMEDIATAMENTE, soporte circulatorio, investigar"
                    },
                    allergic: {
                        mild: "Antihistam√≠nicos, continuar si mejora",
                        severe: "Parar, epinefrina, corticosteroides"
                    },
                    febrile: {
                        action: "Parar, evaluaci√≥n, acetaminof√©n, continuar si estable"
                    }
                }
            }
        };

        // Sistema RAG
        class BloodBankRAG {
            constructor() {
                this.knowledge = knowledgeBase;
                this.conversationHistory = [];
            }

            search(query) {
                const queryLower = query.toLowerCase();
                const results = [];

                // Buscar en toda la base de conocimientos
                this.searchInObject(this.knowledge, queryLower, results, []);
                
                // Ordenar por relevancia
                return results.sort((a, b) => b.score - a.score).slice(0, 5);
            }

            searchInObject(obj, query, results, path) {
                for (const key in obj) {
                    const currentPath = [...path, key];
                    const value = obj[key];
                    
                    if (typeof value === 'string') {
                        const score = this.calculateRelevance(value, query);
                        if (score > 0) {
                            results.push({
                                path: currentPath.join(' > '),
                                content: value,
                                score: score
                            });
                        }
                    } else if (Array.isArray(value)) {
                        value.forEach((item, index) => {
                            if (typeof item === 'string') {
                                const score = this.calculateRelevance(item, query);
                                if (score > 0) {
                                    results.push({
                                        path: `${currentPath.join(' > ')} [${index + 1}]`,
                                        content: item,
                                        score: score
                                    });
                                }
                            }
                        });
                    } else if (typeof value === 'object') {
                        this.searchInObject(value, query, results, currentPath);
                    }
                }
            }

            calculateRelevance(text, query) {
                const textLower = text.toLowerCase();
                let score = 0;

                // Palabras clave cr√≠ticas del banco de sangre
                const criticalTerms = [
                    'transfusion', 'transfusi√≥n', 'sangre', 'blood', 'compatibility', 'compatibilidad',
                    'crossmatch', 'anticuerpo', 'antibody', 'hemolisis', 'hemolysis', 'aglutinacion',
                    'emergency', 'emergencia', 'reaction', 'reaccion', 'donor', 'donante',
                    'recipient', 'receptor', 'plasma', 'platelets', 'plaquetas', 'rbc', 'globulos'
                ];

                // Buscar coincidencias exactas
                if (textLower.includes(query)) {
                    score += 10;
                }

                // Buscar t√©rminos cr√≠ticos
                criticalTerms.forEach(term => {
                    if (query.includes(term) && textLower.includes(term)) {
                        score += 5;
                    }
                });

                // Buscar palabras individuales
                const queryWords = query.split(' ');
                queryWords.forEach(word => {
                    if (word.length > 3 && textLower.includes(word)) {
                        score += 1;
                    }
                });

                return score;
            }

            generateResponse(query) {
                const searchResults = this.search(query);
                
                if (searchResults.length === 0) {
                    return {
                        type: 'no_results',
                        content: 'Lo siento, no encontr√© informaci√≥n espec√≠fica sobre tu consulta. ¬øPodr√≠as ser m√°s espec√≠fico o usar terminolog√≠a cl√≠nica del banco de sangre?'
                    };
                }

                // Determinar el tipo de respuesta basado en la consulta
                const responseType = this.classifyQuery(query);
                
                return {
                    type: responseType,
                    content: this.formatResponse(searchResults, responseType, query),
                    sources: searchResults.slice(0, 3)
                };
            }

            classifyQuery(query) {
                const queryLower = query.toLowerCase();
                
                if (queryLower.includes('calcul') || queryLower.includes('volum') || queryLower.includes('dosis')) {
                    return 'calculation';
                }
                if (queryLower.includes('protocol') || queryLower.includes('procedimiento') || queryLower.includes('paso')) {
                    return 'protocol';
                }
                if (queryLower.includes('emergen') || queryLower.includes('urgent')) {
                    return 'emergency';
                }
                if (queryLower.includes('compatib') || queryLower.includes('crossmatch') || queryLower.includes('cruz')) {
                    return 'compatibility';
                }
                if (queryLower.includes('anticuerpo') || queryLower.includes('antibody')) {
                    return 'antibody';
                }
                if (queryLower.includes('reacci') || queryLower.includes('complicac')) {
                    return 'reaction';
                }
                
                return 'general';
            }

            formatResponse(results, type, query) {
                let response = '';
                
                switch (type) {
                    case 'protocol':
                        response = 'Aqu√≠ tienes el protocolo solicitado:\n\n';
                        break;
                    case 'emergency':
                        response = 'üö® PROTOCOLO DE EMERGENCIA:\n\n';
                        break;
                    case 'calculation':
                        response = 'üìä C√ÅLCULO CL√çNICO:\n\n';
                        break;
                    case 'compatibility':
                        response = 'üî¨ INFORMACI√ìN DE COMPATIBILIDAD:\n\n';
                        break;
                    case 'antibody':
                        response = 'üß™ INFORMACI√ìN SOBRE ANTICUERPOS:\n\n';
                        break;
                    case 'reaction':
                        response = '‚ö†Ô∏è INFORMACI√ìN SOBRE REACCIONES:\n\n';
                        break;
                    default:
                        response = 'Informaci√≥n cl√≠nica encontrada:\n\n';
                }

                results.slice(0, 3).forEach((result, index) => {
                    response += `${index + 1}. ${result.content}\n\n`;
                });

                return response;
            }
        }

        // Instancia del sistema RAG
        const bloodBankRAG = new BloodBankRAG();
        let isTyping = false;

        // Funciones de la interfaz
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            displayMessage(message, 'user');
            input.value = '';
            
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                processMessage(message);
            }, 1500);
        }

        function sendQuickMessage(message) {
            displayMessage(message, 'user');
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                processMessage(message);
            }, 1500);
        }

        function displayMessage(content, sender, isHTML = false) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${sender}`;
            avatar.textContent = sender === 'user' ? 'TM' : 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isHTML) {
                contentDiv.innerHTML = content;
            } else {
                contentDiv.textContent = content;
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString('es-PR');
            
            contentDiv.appendChild(timeDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            
            container.scrollTop = container.scrollHeight;
        }

        function processMessage(query) {
            const response = bloodBankRAG.generateResponse(query);
            let responseHTML = '';
            
            switch (response.type) {
                case 'protocol':
                    responseHTML = `
                        <div class="protocol-steps">
                            <h5>üìã Protocolo Cl√≠nico</h5>
                            <div>${response.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    break;
                    
                case 'emergency':
                    responseHTML = `
                        <div class="safety-warning">
                            <h5>üö® Protocolo de Emergencia</h5>
                            <div>${response.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    break;
                    
                case 'calculation':
                    responseHTML = `
                        <div class="calculation-result">
                            <h5>üìä C√°lculo Cl√≠nico</h5>
                            <div>${response.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    break;
                    
                case 'compatibility':
                    responseHTML = `
                        <div class="clinical-info">
                            <h5>üî¨ Compatibilidad Sangu√≠nea</h5>
                            <div>${response.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    break;
                    
                default:
                    responseHTML = `<div>${response.content.replace(/\n/g, '<br>')}</div>`;
            }
            
            // Agregar fuentes si existen
            if (response.sources && response.sources.length > 0) {
                responseHTML += `
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.8rem; color: #666;">
                        <strong>Fuentes consultadas:</strong><br>
                        ${response.sources.map(source => source.path).join('<br>')}
                    </div>
                `;
            }
            
            displayMessage(responseHTML, 'bot', true);
        }

        function showTyping() {
            if (isTyping) return;
            
            isTyping = true;
            const container = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar bot">ü§ñ</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function useTool(toolType) {
            // Quitar clase active de todos los botones
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Agregar clase active al bot√≥n clickeado
            event.target.classList.add('active');
            
            const toolQueries = {
                compatibility: "¬øC√≥mo realizar e interpretar pruebas de compatibilidad?",
                crossmatch: "Explica el protocolo completo de prueba cruzada",
                antibodies: "¬øC√≥mo identificar anticuerpos irregulares?",
                transfusion: "Calcular dosis de transfusi√≥n seg√∫n peso del paciente",
                volume: "¬øC√≥mo calcular el volumen de sangre total?",
                dilution: "Explicar c√°lculos de diluciones para pruebas serol√≥gicas",
                expiration: "¬øC√≥mo determinar fechas de vencimiento de componentes?",
                inventory: "Protocolo de rotaci√≥n FIFO en banco de sangre",
                emergency: "Protocolo de emergencia para transfusi√≥n masiva",
                quality: "Procedimientos de control de calidad",
                storage: "Condiciones √≥ptimas de almacenamiento por componente",
                safety: "Protocolo de seguridad del paciente en transfusi√≥n",
                guidelines: "Gu√≠as actuales AABB para banco de sangre",
                regulations: "Regulaciones FDA m√°s importantes",
                complications: "Manejo de complicaciones transfusionales"
            };
            
            const query = toolQueries[toolType];
            if (query) {
                sendQuickMessage(query);
            }
        }

        function clearChat() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
                const container = document.getElementById('messagesContainer');
                const messages = container.querySelectorAll('.message:not(:first-child)');
                messages.forEach(msg => msg.remove());
            }
        }

        function exportChat() {
            const messages = document.querySelectorAll('.message');
            let chatLog = 'BLUDEE Assistant - Registro de Consulta\n';
            chatLog += `Fecha: ${new Date().toLocaleDateString('es-PR')}\n`;
            chatLog += '='.repeat(50) + '\n\n';
            
            messages.forEach(message => {
                const sender = message.classList.contains('user') ? 'USUARIO' : 'BLUDEE';
                const content = message.querySelector('.message-content').textContent;
                const time = message.querySelector('.message-time')?.textContent || '';
                
                chatLog += `${sender} (${time}):\n${content}\n\n`;
            });
            
            const blob = new Blob([chatLog], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bludee_consulta_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleVoice() {
            alert('üé§ Funci√≥n de voz en desarrollo\n\nPr√≥ximamente podr√°s:\n‚Ä¢ Dictar consultas por voz\n‚Ä¢ Escuchar respuestas\n‚Ä¢ Comandos de voz');
        }

        function attachFile() {
            alert('üìé Adjuntar archivos en desarrollo\n\nPr√≥ximamente podr√°s:\n‚Ä¢ Subir resultados de laboratorio\n‚Ä¢ Adjuntar im√°genes\n‚Ä¢ Analizar documentos cl√≠nicos');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim();
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        });
    </script>
</body>
</html>
